# 实现计划：清理7天未访问的旧标签页功能

## 概述

为Chrome扩展添加清理7天内未访问标签页的功能。需要在后台脚本中维护标签页的访问时间记录。

## 技术方案

### 方案说明
Chrome Tabs API不直接提供标签页最后访问时间，我们需要：
1. 在后台脚本中监听标签页创建事件（onCreated）
2. 在后台脚本中监听标签页激活事件（onActivated）
3. 维护标签页ID到最后访问时间的映射表
4. 使用chrome.storage.local持久化存储

## 任务列表

- [ ] 1. 实现后台脚本的标签页访问时间跟踪
  - [ ] 1.1 更新background.js添加事件监听
    - 监听chrome.tabs.onCreated事件，记录创建时间
    - 监听chrome.tabs.onActivated事件，更新访问时间
    - 监听chrome.tabs.onRemoved事件，清理已关闭标签页记录
    - _需求: 9.2_

  - [ ] 1.2 实现访问时间存储函数
    - recordTabAccessTime(tabId) - 记录/更新访问时间
    - getTabLastAccessTime(tabId) - 获取最后访问时间
    - removeTabAccessTime(tabId) - 删除访问时间记录
    - _需求: 9.2_

- [ ] 2. 实现旧标签页清理逻辑
  - [ ] 2.1 在popup.js中实现cleanOldTabs函数
    - 获取所有标签页
    - 从storage读取访问时间
    - 识别7天未访问的标签页
    - 应用保护规则（固定、音频、内部页面）
    - 关闭符合条件的标签页
    - _需求: 9.1, 9.3, 9.4, 9.5, 9.6_

  - [ ] 2.2 实现清理结果反馈
    - 统计清理的标签页数量
    - 显示清理结果消息
    - _需求: 9.7, 9.8_

- [ ] 3. 更新用户界面
  - [ ] 3.1 在popup.html中添加清理旧标签页按钮
    - 添加新按钮HTML
    - 设计按钮样式（与现有按钮保持一致）
    - _需求: 9.1_

  - [ ] 3.2 在popup.js中添加按钮事件处理
    - 绑定按钮点击事件
    - 调用cleanOldTabs函数
    - 显示清理结果
    - _需求: 9.7_

- [ ] 4. 更新manifest.json
  - [ ] 4.1 配置后台脚本
    - 添加background service_worker配置
    - 指向background.js文件
    - _需求: 9.1_

- [ ] 5. 测试和验证
  - [ ] 5.1 功能测试
    - 测试访问时间跟踪是否正确
    - 测试7天判断逻辑
    - 测试保护规则（固定、音频、内部页面）
    - _需求: 9.1-9.8_

  - [ ] 5.2 边缘情况测试
    - 测试扩展重启后的数据持久化
    - 测试没有旧标签页的情况
    - 测试所有标签页都被保护的情况
    - _需求: 9.8_

## 实现注意事项

1. **数据持久化** - 访问时间需要存储在chrome.storage.local
2. **保护规则** - 固定标签页(pinned)、音频标签页(audible)、内部页面都要跳过
3. **用户反馈** - 清理完成后只显示清理数量，简洁明了
4. **向后兼容** - 确保新功能不影响现有的重复标签页清理功能
5. **性能考虑** - 定期清理已关闭标签页的记录，避免存储膨胀

## 预期时间

- 后台脚本实现：30分钟
- 清理逻辑实现：20分钟
- 界面更新：10分钟
- 测试验证：10分钟
- 总计：约70分钟
